name: ETHER SERVER

on:
  workflow_dispatch:
    inputs:
      ts_authkey:
        description: "Tailscale Auth key"
        required: true
      cycles:
        description: "Number of cycles"
        required: false
        default: "1"

permissions:
  contents: read
  actions: write

jobs:
  full:
    runs-on: windows-latest
    timeout-minutes: 360

    env:
      RDP_USER: sedor
      RDP_PASS: Mariya@1981
      MAIN_RUNTIME_MIN: 360
      MUMU_MGR: 'C:\Program Files\Netease\MuMuPlayer\nx_main\MuMuManager.exe'

    steps:

    # ---------------- BASIC ----------------
    - name: Show runner info
      shell: pwsh
      run: |
        whoami
        systeminfo | findstr /B /C:"OS Name"

    # ---------------- TAILSCALE ----------------
    - name: Install and Start Tailscale
      shell: pwsh
      run: |
        $exe = "$env:ProgramFiles\Tailscale\tailscale.exe"

        if (-not (Test-Path $exe)) {
          Invoke-WebRequest `
            https://pkgs.tailscale.com/stable/tailscale-setup-1.82.0-amd64.msi `
            -OutFile tailscale.msi
          Start-Process msiexec.exe -ArgumentList "/i tailscale.msi /quiet /norestart" -Wait
        }

        Start-Service Tailscale
        Start-Sleep 10

        & $exe up --authkey "${{ inputs.ts_authkey }}" --hostname "bullet"

        for ($i=0; $i -lt 10; $i++) {
          $ip = & $exe ip -4 | Select-Object -First 1
          if ($ip) { break }
          Start-Sleep 3
        }

        if (-not $ip) { throw "Tailscale IP not found" }

        echo "TS_IP=$ip" >> $env:GITHUB_ENV
        Write-Host "Tailscale IP: $ip"

    # ---------------- RDP ----------------
    - name: Enable RDP
      shell: pwsh
      run: |
        $sec = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force

        if (-not (Get-LocalUser $env:RDP_USER -EA SilentlyContinue)) {
          New-LocalUser $env:RDP_USER -Password $sec
          Add-LocalGroupMember Administrators $env:RDP_USER
          Add-LocalGroupMember "Remote Desktop Users" $env:RDP_USER
        }

        Set-ItemProperty `
          "HKLM:\System\CurrentControlSet\Control\Terminal Server" `
          -Name fDenyTSConnections -Value 0

        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

     # ---------------- PYTHON ----------------
    - name: Install Python modules
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        pip install gdown
        py -m install customtkinter
        py -m install uiautomator2
        py -m install playwright
        pip install customtkinter
        pip install uiautomator2
        pip install opencv-python
        pip install playwright
        py -m playwright install
        playwright install


   # ---------------- MUMU AUTO SETUP ----------------
    - name: Auto MuMu Download & Restore
      shell: pwsh
      run: |
        # 1. Download Backup
        gdown --id "166R8NrD3kHJZTNdhI2P8NIEzurgpf5Gp" -O "$env:USERPROFILE\Downloads\fb.mumudata"

        # 2. Download Bot Folder (Corrected Syntax)
        gdown --folder "17fags-9sHCQU2ZlNe1BySx-7gdU1cla2" --output "$env:USERPROFILE\Desktop\fbcreator_folder"

        # 3. Download and Silent Install MuMu
        $mumuUrl = "https://a11.gdl.netease.com/MuMu_5.0.7_gw-win-download_all_1761811684.exe"
        Invoke-WebRequest -Uri $mumuUrl -OutFile "$env:TEMP\mumu.exe"
        Start-Process "$env:TEMP\mumu.exe" -ArgumentList "/S" -Wait
        Start-Sleep -Seconds 50

        # 4. Restore and Launch 3 Emulators
        if (Test-Path $env:MUMU_MGR) {
            for ($i=0; $i -lt 3; $i++) {
                Write-Host "Configuring Instance $i..."
                & $env:MUMU_MGR restore --index $i --file "$env:USERPROFILE\Downloads\fb.mumudata"
                & $env:MUMU_MGR config index $i cpu 1 memory 4096 graphics_type 2 disk_mode 2
                & $env:MUMU_MGR launch index $i
                Start-Sleep -Seconds 15
            }
        } else {
            Write-Host "Error: MuMuManager path not found at $env:MUMU_MGR"
        }
    # ---------------- KEEP ALIVE ----------------
    - name: Keep alive
      shell: pwsh
      run: |
        Start-Sleep -Seconds 43200

    - name: Done
      shell: pwsh
      run: |
        Write-Host "DONE"
        Write-Host "RDP IP: $env:TS_IP"

